\section{S\+F\+M}
\label{group__SFM}\index{S\+F\+M@{S\+F\+M}}


Structure From Motion (S\+F\+M) module for estimation of estrinsics parameter and computation of depth map.  


Structure From Motion (S\+F\+M) module for estimation of estrinsics parameter and computation of depth map. 

Copyright (C) 2013 Robot\+Cub Consortium

Author\+: Sean Ryan Fanello

Date\+: first release around 24/07/2013

Copy\+Policy\+: Released under the terms of the G\+N\+U G\+P\+L v2.\+0.\hypertarget{group__SFM_intro_sec}{}\subsection{Description}\label{group__SFM_intro_sec}
The module uses a complete Structure From Motion (S\+F\+M) pipeline for the computation of the extrinsics parameters between two different views. These parameters are then used to rectify the images and to compute a depth map using the H. Hirschmuller Algorithm (C\+V\+P\+R 2006) implemented since Opencv 2.\+2. The Kinematics of the i\+Cub is used to guess the current camera positions, then visual features are used to refine this model. Before starting, make sure you have calibrated the intrinsics parameters. For the stereo calibration see the module \href{http://wiki.icub.org/iCub/main/dox/html/group__icub__stereoCalib.html}{\tt stereo\+Calib}. The module provides three output ports\+: the first one is the disparity map in grayscale values, the second port is the World\+Image, that is a 3-\/channels float image, where in each pixel are stored the three X Y Z coordinates with respect to robot root reference frame. The third port outputs the current keypoints match. Non valid points are handled with the special value (0,0,0). In addition, a rpc port supports requests for 3\+D/2\+D points computation (see below).\hypertarget{group__SFM_lib_sec}{}\subsection{Libraries}\label{group__SFM_lib_sec}
Y\+A\+R\+P libraries and Open\+C\+V 2.\+4 (at least). ~\newline
For better performance, we suggest you to run the module on a machine equipped with G\+P\+U functionality along with the \href{http://cs.unc.edu/~ccwu/siftgpu}{\tt Sift\+G\+P\+U} library installed.\hypertarget{group__SFM_parameters_sec}{}\subsection{Parameters}\label{group__SFM_parameters_sec}
--name {\itshape S\+F\+M} 
\begin{DoxyItemize}
\item The parameter {\itshape stem\+Name} specifies the stem name of ports created by the module.
\end{DoxyItemize}

--robot {\itshape robot\+Name} 
\begin{DoxyItemize}
\item The parameter {\itshape robot\+Name} specifies the name of the robot.
\end{DoxyItemize}

--left\+Port {\itshape /left}\+:i
\begin{DoxyItemize}
\item The parameter {\itshape input\+Left} specifies the left image input port.
\end{DoxyItemize}

--right\+Port {\itshape /right}\+:i
\begin{DoxyItemize}
\item The parameter {\itshape input\+Right} specifies the right image input port.
\end{DoxyItemize}

--out\+Disp\+Port {\itshape /disp}\+:o
\begin{DoxyItemize}
\item The parameter {\itshape /disparity}\+:o specifies the output port for the disparity image.
\end{DoxyItemize}

--out\+Match\+Port {\itshape /match}\+:o
\begin{DoxyItemize}
\item The parameter {\itshape /match}\+:o specifies the output port for the match image.
\end{DoxyItemize}

--out\+World\+Port {\itshape /world}\+:o
\begin{DoxyItemize}
\item The parameter {\itshape /world}\+:o specifies the output port for the world image.
\end{DoxyItemize}

--Command\+Port {\itshape comm} 
\begin{DoxyItemize}
\item The parameter {\itshape comm} specifies the command port for rpc protocol.
\end{DoxyItemize}\hypertarget{group__SFM_portsc_sec}{}\subsection{Ports Created}\label{group__SFM_portsc_sec}

\begin{DoxyItemize}
\item {\itshape  /\+S\+F\+M/left\+:i } accepts the incoming images from the left eye.
\item {\itshape  /\+S\+F\+M/right\+:i } accepts the incoming images from the right eye.
\item {\itshape  /\+S\+F\+M/disp\+:o } outputs the disparity map in grayscale values.
\item {\itshape  /\+S\+F\+M/world\+:o} outputs the world image (3-\/channel float with X Y Z values).
\item {\itshape  /\+S\+F\+M/match\+:o} outputs the match image.
\item {\itshape  /\+S\+F\+M/rpc } for terminal commands communication.
\begin{DoxyItemize}
\item \mbox{[}calibrate\mbox{]}\+: It recomputes the camera positions once.
\item \mbox{[}save\mbox{]}\+: It saves the current camera positions and uses it when the module starts.
\item \mbox{[}get\+H\mbox{]}\+: It returns the calibrated stereo matrix.
\item \mbox{[}set\+Num\+Disp Num\+Of\+Disparities\mbox{]}\+: It sets the expected number of disparity (in pixel). Values must be divisible by 32. Good values are 64 for 320x240 images and 128 for 640x480 images.
\item \mbox{[}Point x y\mbox{]}\+: Given the pixel coordinate x,y in the Left image the response is the 3\+D Point\+: X Y Z computed using the depth map wrt the L\+E\+F\+T eye. Points with non valid disparity (i.\+e. occlusions) are handled with the value (0.\+0,0.\+0,0.\+0).
\item \mbox{[}x y\mbox{]}\+: Given the pixel coordinate x,y in the Left image the response is the 3\+D Point\+: X Y Z d computed using the depth map wrt the the R\+O\+O\+T reference system, d is the disparity (in pixel) between the left pixel x and the right pixel x+d. Points with non valid disparity (i.\+e. occlusions) are handled with the value (0.\+0,0.\+0,0.\+0).
\item \mbox{[}Left x y\mbox{]}\+: Given the pixel coordinate x,y in the Left image the response is the 3\+D Point\+: X Y Z computed using the depth map wrt the L\+E\+F\+T eye. Points with non valid disparity (i.\+e. occlusions) are handled with the value (0.\+0,0.\+0,0.\+0).
\item \mbox{[}Right x y\mbox{]}\+: Given the pixel coordinate x,y in the Left image the response is the 3\+D Point\+: X Y Z computed using the depth map wrt the R\+I\+G\+H\+T eye. Points with non valid disparity (i.\+e. occlusions) are handled with the value (0.\+0,0.\+0,0.\+0).
\item \mbox{[}Root x y\mbox{]}\+: Given the pixel coordinate x,y in the Left image the response is the 3\+D Point\+: X Y Z computed using the depth map wrt the R\+O\+O\+T reference system. Points with non valid disparity (i.\+e. occlusions) are handled with the value (0.\+0,0.\+0,0.\+0).
\item \mbox{[}u\+L\+\_\+1 v\+L\+\_\+1 u\+R\+\_\+1 v\+R\+\_\+1 ... u\+L\+\_\+n v\+L\+\_\+n u\+R\+\_\+n v\+R\+\_\+n\mbox{]}\+: Given n quadruples u\+L\+\_\+i v\+L\+\_\+i u\+R\+\_\+i v\+R\+\_\+i, where u\+L\+\_\+i v\+L\+\_\+i are the pixel coordinates in the Left image and u\+R\+\_\+i v\+R\+\_\+i are the coordinates of the matched pixel in the Right image, the response is a set of 3\+D points (X1 Y1 Z1 ... Xn Yn Zn) wrt the R\+O\+O\+T reference system.
\item \mbox{[}cart2stereo X Y Z\mbox{]}\+: Given a world point X Y Z wrt to R\+O\+O\+T reference frame the response is the projection (u\+L v\+L u\+R v\+R) in the Left and Right images.
\end{DoxyItemize}
\end{DoxyItemize}\hypertarget{group__SFM_in_files_sec}{}\subsection{Input Data Files}\label{group__SFM_in_files_sec}
None.\hypertarget{group__SFM_out_data_sec}{}\subsection{Output Data Files}\label{group__SFM_out_data_sec}
None.\hypertarget{group__SFM_tested_os_sec}{}\subsection{Tested O\+S}\label{group__SFM_tested_os_sec}
Linux (Ubuntu 9.\+04, Debian Squeeze) and Windows 7. Tested against Open\+C\+V versions\+: 2.\+4.

\begin{DoxyAuthor}{Author}
Sean Ryan Fanello 
\end{DoxyAuthor}
